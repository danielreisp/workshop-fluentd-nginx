<source>
  @type syslog
  port 24224
  bind 0.0.0.0
  tag nginx_access
  @label @mainstream
</source>

<source>
  @type syslog
  tag nginx_error
  port  24225
  bind 0.0.0.0
  @label @mainstream
  <parse>
    @type multi_format
    <pattern>
      key_name message
      time_key time
      time_format %d/%b/%Y:%H:%M:%S %z
      format /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message-error>.*)$/
    </pattern>
    <pattern>
      key_name message-error
      format /(?<begin>[^,]*) \[file \"(?<file>[^ ]*)\"\] \[line \"(?<line>[^ ]*)\"\] \[id \"(?<id>[^ ]*)\"\] \[rev \"(?<rev>[^ ]*)\"\] \[msg \"(?<msg>[^ ]*)\] \[data (?<data>[^ ]*)\] \[severity \"(?<severity>[^ ]*)\"\] \[ver (?<ver>[^ ]*)\] \[maturity \"(?<maturity>[^ ]*)\"\] \[accuracy \"(?<accuracy>[^ ]*)\"\] \[hostname \"(?<hostname>[^ ]*)\"\] \[uri \"(?<uri>[^ ]*)\"\] \[unique_id \"(?<unique_id>[^ ]*)\"\] \[ref (?<ref>[^ ]*)\][,]* client:(?<client>[ ([^ ,]*)]*)[,]* server:(?<server>[ ([^ ,]*)]*)[,]* request: \"(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)? host: \"(?<host>[^ ]*)\"/
    </pattern>
    <pattern>
      key_name message
      format /(?<begin>[^,]*)(?<limit_request>limiting requests[^ ]*)[,]+ excess: (?<excess>[^ ]*) by zone \"(?<zone>[^ ]*)\"\, client: (?<client>[^ ]*)\, server: (?<server>[^ ]*)\, request: \"(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?\, host: \"(?<host>[^ ]*)\"/
    </pattern>
    <pattern>
     format none
    </pattern>
  </parse>
</source>

<label @mainstream>
 <filter nginx_access.*.* >
    @type parser
    key_name message
    <parse>
      @type json
      json_parser yajl
    </parse>
  </filter>
  <filter *.*.*>
    @type elasticsearch_genid
    hash_id_key _hash
  </filter>
  <match *.*.*>
    @type copy 
    <store>
      @type stdout
    </store>
    <store>
      @log_level debug
      @type elasticsearch
      
      host elasticsearch
      port 9200
      
      logstash_format true
      
      logstash_prefix workshop
      logstash_dateformat %Y%m%d
      
      id_key _hash
      remove_keys _hash
      #// TODO revisar tag_key 
      include_tag_key true
      tag_key @log_name
      type_name @tag
      
      flush_interval 1s

      <buffer tag>
        #@type memory  # file #or memory
        @type file
        path /tmp/fluentd*.buffer
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 4
        flush_interval 1s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 2M
        queue_limit_length 8
        overflow_action block
      </buffer>
    </store>
  </match>
 
</label>
